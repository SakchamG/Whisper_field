<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper Field - Anonymous Whispers</title>
    <style>
        /* CSS Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0c0c1d;
            --card-glass: rgba(20, 20, 40, 0.85);
            --primary-purple: #9d4edd;
            --glow-accent: #c77dff;
            --text-light: #f8f9fa;
            --text-muted: #adb5bd;
            --border-glow: rgba(157, 78, 221, 0.3);
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Cosmic Background */
        #cosmic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            overflow: hidden;
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        .moon {
            position: absolute;
            top: 10%;
            right: 10%;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle at 30% 30%, #f8f9fa, #adb5bd 70%);
            border-radius: 50%;
            box-shadow: 0 0 40px rgba(248, 249, 250, 0.3);
            animation: float 20s infinite ease-in-out;
        }

        .mountains {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 200px;
            background: linear-gradient(to top, #0a0a18, transparent);
            z-index: -1;
        }

        /* Animations */
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); }
            25% { transform: translateY(-20px) translateX(10px); }
            50% { transform: translateY(0) translateX(20px); }
            75% { transform: translateY(20px) translateX(10px); }
        }

        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 0 20px var(--border-glow); }
            50% { box-shadow: 0 0 30px var(--glow-accent); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Header */
        .header {
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            background: rgba(12, 12, 29, 0.7);
            border-bottom: 1px solid var(--border-glow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-purple), var(--glow-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
            cursor: pointer;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-link {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            letter-spacing: 1px;
            transition: color 0.3s;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--text-light);
            background: rgba(157, 78, 221, 0.1);
            border: 1px solid var(--border-glow);
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            animation: fadeIn 0.5s ease-out;
        }

        .page-title {
            font-size: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            letter-spacing: 3px;
        }

        /* Browse Page - Whisper Grid */
        .whispers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        @media (max-width: 1100px) {
            .whispers-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Whisper Card */
        .whisper-card {
            background: var(--card-glass);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid var(--border-glow);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: slideIn 0.4s ease-out;
        }

        .whisper-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-purple);
            animation: glow-pulse 2s infinite;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .anonymous-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-purple), var(--bg-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--text-light);
        }

        .topic-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        /* Updated topics - replaced love with relationship */
        .topic-confession { background: rgba(157, 78, 221, 0.2); color: #c77dff; }
        .topic-life { background: rgba(0, 200, 255, 0.2); color: #00c8ff; }
        .topic-secrets { background: rgba(255, 100, 100, 0.2); color: #ff6464; }
        .topic-advice { background: rgba(100, 255, 100, 0.2); color: #64ff64; }
        .topic-relationship { background: rgba(255, 100, 200, 0.2); color: #ff64c8; }
        .topic-random { background: rgba(200, 200, 100, 0.2); color: #c8c864; }
        .topic-series-movies { background: rgba(255, 152, 0, 0.2); color: #ff9800; }
        .topic-politically-incorrect { background: rgba(244, 67, 54, 0.2); color: #f44336; }
        .topic-paranormal { background: rgba(156, 39, 176, 0.2); color: #9c27b0; }
        .topic-health-fitness { background: rgba(76, 175, 80, 0.2); color: #4caf50; }
        .topic-vent { background: rgba(96, 125, 139, 0.2); color: #607d8b; }
        .topic-music { background: rgba(233, 30, 99, 0.2); color: #e91e63; }
        .topic-fashion { background: rgba(0, 188, 212, 0.2); color: #00bcd4; }
        .topic-gaming { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .topic-otaku-stuff { background: rgba(103, 58, 183, 0.2); color: #673ab7; }

        .whisper-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 0.8rem;
            line-height: 1.4;
            letter-spacing: 0.5px;
        }

        .whisper-preview {
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 1rem;
            max-height: 80px;
            overflow: hidden;
            position: relative;
            font-size: 0.95rem;
        }

        .whisper-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30px;
            background: linear-gradient(transparent, var(--card-glass));
        }

        .sensitive-blur {
            filter: blur(8px);
            user-select: none;
            pointer-events: none;
        }

        .sensitive-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            text-align: center;
            padding: 2rem;
            z-index: 2;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-muted);
            font-size: 0.85rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .sensitive-badge {
            color: #ff6464;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .auto-delete {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        /* More Dropdown Styles */
        .more-dropdown {
            position: relative;
            display: inline-block;
        }

        .more-dropdown-content {
            display: none;
            position: absolute;
            background: var(--card-glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-glow);
            border-radius: 10px;
            padding: 0.5rem;
            z-index: 1000;
            min-width: 200px;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            animation: fadeIn 0.2s ease-out;
        }

        .more-dropdown-content.show {
            display: block;
        }

        .dropdown-topic-btn {
            display: block;
            width: 100%;
            padding: 0.5rem 1rem;
            margin: 0.2rem 0;
            background: rgba(40, 40, 70, 0.7);
            border: 1px solid var(--border-glow);
            border-radius: 15px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            font-size: 0.85rem;
        }

        .dropdown-topic-btn:hover, .dropdown-topic-btn.active {
            background: rgba(157, 78, 221, 0.3);
            color: var(--glow-accent);
            border-color: var(--primary-purple);
        }

        .more-button {
            background: rgba(40, 40, 70, 0.7);
            border: 1px solid var(--border-glow);
            border-radius: 20px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s;
            padding: 0.5rem 1.5rem;
            font-size: 0.9rem;
            position: relative;
        }

        .more-button:hover, .more-button.active {
            background: rgba(157, 78, 221, 0.3);
            color: var(--glow-accent);
            border-color: var(--primary-purple);
        }

        .more-button::after {
            content: '‚ñº';
            margin-left: 0.5rem;
            font-size: 0.7rem;
            transition: transform 0.3s;
        }

        .more-button.show::after {
            transform: rotate(180deg);
        }

        /* Full Whisper View */
        .full-whisper-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            animation: fadeIn 0.4s ease-out;
        }

        .full-view-header {
            position: sticky;
            top: 0;
            backdrop-filter: blur(20px);
            background: rgba(12, 12, 29, 0.9);
            border-bottom: 1px solid var(--border-glow);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            margin: -2rem -2rem 2rem -2rem;
            animation: slideIn 0.3s ease-out;
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: transparent;
            border: 1px solid var(--border-glow);
            color: var(--text-light);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            border-color: var(--primary-purple);
            background: rgba(157, 78, 221, 0.1);
        }

        .full-whisper-card {
            background: var(--card-glass);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid var(--border-glow);
            padding: 2.5rem;
            margin-bottom: 2rem;
            animation: glow-pulse 4s infinite;
            animation: slideIn 0.4s ease-out;
        }

        .full-whisper-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 1.5rem;
            line-height: 1.4;
            letter-spacing: 1px;
        }

        .full-content {
            font-size: 1.1rem;
            line-height: 1.8;
            margin: 2rem 0;
            color: var(--text-light);
        }

        .full-footer {
            color: var(--text-muted);
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 1.5rem;
        }

        /* Sensitive Content Warning (inside whisper) */
        .sensitive-warning {
            background: rgba(20, 20, 40, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            border: 2px solid #ff6464;
            margin-bottom: 2rem;
            animation: fadeIn 0.4s ease-out;
        }

        .warning-icon {
            font-size: 3rem;
            color: #ff6464;
            margin-bottom: 1rem;
        }

        .warning-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        /* Exit Warning Modal */
        .exit-warning-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            animation: fadeIn 0.3s ease-out;
        }

        .exit-warning-content {
            background: var(--card-glass);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            padding: 3rem;
            width: 90%;
            max-width: 500px;
            border: 2px solid #ff6464;
            text-align: center;
            animation: slideIn 0.4s ease-out;
        }

        .exit-warning-icon {
            font-size: 4rem;
            color: #ff6464;
            margin-bottom: 1.5rem;
        }

        .exit-warning-title {
            font-size: 1.8rem;
            color: var(--text-light);
            margin-bottom: 1rem;
            letter-spacing: 1px;
        }

        .exit-warning-text {
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .exit-warning-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .exit-countdown {
            font-size: 3rem;
            color: var(--primary-purple);
            margin: 1rem 0;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .exit-instruction {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 1rem;
            font-style: italic;
        }

        /* Replies Section */
        .replies-section {
            background: var(--card-glass);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--border-glow);
            margin-top: 2rem;
            animation: slideIn 0.5s ease-out;
        }

        .replies-title {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            color: var(--text-light);
        }

        .reply {
            background: rgba(30, 30, 50, 0.5);
            border-radius: 10px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            border-left: 3px solid var(--primary-purple);
            animation: slideIn 0.3s ease-out;
        }

        .reply-content {
            color: var(--text-light);
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .reply-footer {
            color: var(--text-muted);
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
        }

        /* Reply Input */
        .reply-input-container {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .reply-textarea {
            width: 100%;
            background: rgba(30, 30, 50, 0.7);
            border: 1px solid var(--border-glow);
            border-radius: 10px;
            padding: 1rem;
            color: var(--text-light);
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 120px;
            margin-bottom: 1rem;
        }

        .reply-textarea:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 20px var(--border-glow);
        }

        .input-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .char-counter {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .char-counter.warning {
            color: #ff6464;
        }

        .human-verification {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .verification-checkbox {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-purple);
        }

        /* Buttons */
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-weight: 700;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-purple), var(--glow-accent));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(157, 78, 221, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--text-muted);
        }

        .btn-secondary:hover {
            color: var(--text-light);
            border-color: var(--text-light);
        }

        .btn-danger {
            background: rgba(255, 100, 100, 0.2);
            color: #ff6464;
            border: 1px solid #ff6464;
        }

        .btn-danger:hover {
            background: rgba(255, 100, 100, 0.3);
        }

        .btn-success {
            background: rgba(100, 255, 100, 0.2);
            color: #64ff64;
            border: 1px solid #64ff64;
        }

        .btn-success:hover {
            background: rgba(100, 255, 100, 0.3);
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-purple), var(--glow-accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            box-shadow: 0 0 30px rgba(157, 78, 221, 0.5);
            z-index: 1000;
            transition: all 0.3s;
            border: none;
            animation: fadeIn 0.5s ease-out;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 0 40px rgba(199, 125, 255, 0.8);
        }

        /* Post Whisper Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: var(--card-glass);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2.5rem;
            width: 90%;
            max-width: 600px;
            border: 1px solid var(--border-glow);
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.4s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--text-light);
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-light);
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .whisper-title-input {
            width: 100%;
            background: rgba(30, 30, 50, 0.7);
            border: 1px solid var(--border-glow);
            border-radius: 10px;
            padding: 0.8rem;
            color: var(--text-light);
            font-family: inherit;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .whisper-textarea {
            width: 100%;
            background: rgba(30, 30, 50, 0.7);
            border: 1px solid var(--border-glow);
            border-radius: 10px;
            padding: 1rem;
            color: var(--text-light);
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            min-height: 180px;
        }

        .topic-select {
            width: 100%;
            padding: 0.8rem;
            background: rgba(30, 30, 50, 0.7);
            border: 1px solid var(--border-glow);
            border-radius: 10px;
            color: var(--text-light);
            font-family: inherit;
        }

        .sensitive-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-light);
        }

        /* Topic Filter */
        .topic-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 2rem;
            justify-content: center;
        }

        .topic-filter-btn {
            padding: 0.5rem 1.5rem;
            background: rgba(40, 40, 70, 0.7);
            border: 1px solid var(--border-glow);
            border-radius: 20px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s;
        }

        .topic-filter-btn:hover, .topic-filter-btn.active {
            background: rgba(157, 78, 221, 0.3);
            color: var(--glow-accent);
            border-color: var(--primary-purple);
        }

        /* Hidden Content */
        .hidden-content {
            filter: blur(10px);
            user-select: none;
            pointer-events: none;
            opacity: 0.3;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(20, 20, 40, 0.5);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-purple);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--glow-accent);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .nav-links {
                gap: 0.5rem;
            }

            .nav-link {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }

            .whispers-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .container {
                padding: 1rem;
            }

            .full-view-header {
                padding: 0.8rem 1rem;
                margin: -1rem -1rem 1rem -1rem;
            }

            .fab {
                bottom: 1rem;
                right: 1rem;
                width: 50px;
                height: 50px;
            }

            .more-dropdown-content {
                right: -50px;
                min-width: 180px;
            }

            .whisper-title {
                font-size: 1.1rem;
            }

            .full-whisper-title {
                font-size: 1.5rem;
            }

            .exit-warning-content {
                padding: 2rem;
                margin: 1rem;
            }

            .exit-warning-title {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Cosmic Background -->
    <div id="cosmic-bg">
        <div class="moon"></div>
        <div class="mountains"></div>
    </div>

    <!-- Global Header -->
    <header class="header">
        <div class="logo" id="home-button">WHISPER FIELD</div>
        <nav class="nav-links">
            <a href="#" class="nav-link active" id="nav-browse">BROWSE WHISPERS</a>
        </nav>
    </header>

    <!-- Page 1: Browse Whispers -->
    <main id="browse-page" class="container">
        <h1 class="page-title">RECENT WHISPERS</h1>

        <!-- Topic Filter with More Dropdown -->
        <div class="topic-filter" id="topic-filter">
            <button class="topic-filter-btn active" data-topic="all">ALL</button>
            <button class="topic-filter-btn" data-topic="confession">CONFESSION</button>
            <button class="topic-filter-btn" data-topic="life">LIFE</button>
            <button class="topic-filter-btn" data-topic="secrets">SECRETS</button>
            <button class="topic-filter-btn" data-topic="advice">ADVICE</button>

            <!-- More Dropdown -->
            <div class="more-dropdown">
                <button class="more-button" id="more-btn">MORE</button>
                <div class="more-dropdown-content" id="more-dropdown">
                    <button class="dropdown-topic-btn" data-topic="relationship">RELATIONSHIP</button>
                    <button class="dropdown-topic-btn" data-topic="series-movies">SERIES/MOVIES</button>
                    <button class="dropdown-topic-btn" data-topic="politically-incorrect">POLITICALLY INCORRECT</button>
                    <button class="dropdown-topic-btn" data-topic="paranormal">PARANORMAL</button>
                    <button class="dropdown-topic-btn" data-topic="health-fitness">HEALTH/FITNESS</button>
                    <button class="dropdown-topic-btn" data-topic="vent">VENT</button>
                    <button class="dropdown-topic-btn" data-topic="music">MUSIC</button>
                    <button class="dropdown-topic-btn" data-topic="fashion">FASHION</button>
                    <button class="dropdown-topic-btn" data-topic="gaming">GAMING</button>
                    <button class="dropdown-topic-btn" data-topic="otaku-stuff">OTAKU STUFF</button>
                    <button class="dropdown-topic-btn" data-topic="random">RANDOM</button>
                </div>
            </div>
        </div>

        <!-- Whisper Grid -->
        <div class="whispers-grid" id="whispers-grid">
            <!-- Whisper cards will be inserted here by JavaScript -->
        </div>

        <!-- Loading Indicator -->
        <div id="loading" style="text-align: center; color: var(--text-muted); display: none;">
            Loading whispers...
        </div>
    </main>

    <!-- Page 2: Full Whisper View -->
    <div id="whisper-page" class="container hidden">
        <div class="full-whisper-container" id="whisper-container">
            <!-- Sticky Top Bar -->
            <div class="full-view-header">
                <button class="back-button" id="back-button">
                    ‚Üê Back to Browse
                </button>
                <div class="topic-badge" id="full-topic-badge">CONFESSION</div>
                <div class="auto-delete">
                    Auto-deletes in <span id="delete-hours">48</span>h
                </div>
            </div>

            <!-- Sensitive warning will be inserted here if needed -->
            
            <!-- Whisper content -->
            <div class="full-whisper-card" id="whisper-content-card">
                <div class="card-header">
                    <div class="anonymous-icon">?</div>
                    <div class="topic-badge topic-confession" id="full-topic">CONFESSION</div>
                </div>

                <h1 class="full-whisper-title" id="full-whisper-title">
                    <!-- Title will be inserted here -->
                </h1>

                <div class="full-content" id="full-whisper-content">
                    <!-- Full content will be inserted here -->
                </div>

                <div class="full-footer">
                    <div class="footer-left">
                        <div class="timestamp">üïí <span id="full-timestamp">4h ago</span></div>
                        <div class="replies-count">üí¨ <span id="full-replies-count">3</span> replies</div>
                    </div>
                    <div class="footer-right">
                        <div class="sensitive-badge hidden" id="sensitive-indicator">
                            ‚ö†Ô∏è SENSITIVE CONTENT
                        </div>
                    </div>
                </div>
            </div>

            <!-- Replies Section -->
            <div class="replies-section" id="replies-section">
                <h3 class="replies-title">üí¨ REPLIES</h3>
                <div id="replies-container">
                    <!-- Replies will be inserted here -->
                </div>

                <!-- Reply Input -->
                <div class="reply-input-container">
                    <textarea class="reply-textarea" placeholder="Write an anonymous reply (max 150 words)..." maxlength="750" id="reply-textarea"></textarea>
                    <div class="input-footer">
                        <div class="char-counter" id="reply-char-counter">
                            <span id="reply-chars">0</span>/750 characters ‚Ä¢ <span id="reply-words">0</span>/150 words
                        </div>
                        <div class="human-verification">
                            <input type="checkbox" id="human-check" class="verification-checkbox">
                            <label for="human-check">I am human</label>
                        </div>
                        <button class="btn btn-primary" id="submit-reply">POST REPLY</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" id="fab">+</button>

    <!-- Post Whisper Modal -->
    <div class="modal-overlay" id="post-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">POST A WHISPER</h2>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>

            <div class="form-group">
                <label class="form-label">TITLE</label>
                <input type="text" class="whisper-title-input" id="whisper-title" placeholder="Give your whisper a title..." maxlength="100">
                <div class="char-counter" style="text-align: right; margin-top: 0.2rem;">
                    <span id="title-chars">0</span>/100
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">YOUR WHISPER</label>
                <textarea class="whisper-textarea" id="new-whisper" placeholder="Share your thoughts anonymously..." maxlength="1000"></textarea>
                <div class="char-counter" style="text-align: right; margin-top: 0.5rem;">
                    <span id="whisper-chars">0</span>/1000
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">TOPIC</label>
                <select class="topic-select" id="whisper-topic">
                    <option value="confession">Confession</option>
                    <option value="life">Life</option>
                    <option value="secrets">Secrets</option>
                    <option value="advice">Advice</option>
                    <option value="relationship">Relationship</option>
                    <option value="series-movies">Series/Movies</option>
                    <option value="politically-incorrect">Politically Incorrect</option>
                    <option value="paranormal">Paranormal</option>
                    <option value="health-fitness">Health/Fitness</option>
                    <option value="vent">Vent</option>
                    <option value="music">Music</option>
                    <option value="fashion">Fashion</option>
                    <option value="gaming">Gaming</option>
                    <option value="otaku-stuff">Otaku Stuff</option>
                    <option value="random">Random</option>
                </select>
            </div>

            <div class="form-group">
                <label class="sensitive-checkbox">
                    <input type="checkbox" id="sensitive-toggle-modal">
                    Mark as sensitive content
                </label>
            </div>

            <div class="form-group">
                <label class="human-verification">
                    <input type="checkbox" id="post-human-check" class="verification-checkbox">
                    I am human
                </label>
            </div>

            <button class="btn btn-primary" id="submit-whisper" style="width: 100%; padding: 1rem;">POST ANONYMOUSLY</button>
        </div>
    </div>

    <!-- Exit Warning Modal -->
    <div class="exit-warning-modal" id="exit-warning-modal">
        <div class="exit-warning-content">
            <div class="exit-warning-icon">‚ö†Ô∏è</div>
            <h2 class="exit-warning-title">EXIT CONFIRMATION</h2>
            <p class="exit-warning-text">
                Are you sure you want to leave Whisper Field?<br>
                Press the exit button again within <span id="exit-timer">3</span> seconds to confirm.
            </p>
            <div class="exit-countdown" id="exit-countdown">3</div>
            <div class="exit-warning-buttons">
                <button class="btn btn-success" id="confirm-exit">EXIT NOW</button>
                <button class="btn btn-secondary" id="cancel-exit">STAY HERE</button>
            </div>
            <p class="exit-instruction">
                Note: Pressing browser back button will return you to browse page, not exit.
            </p>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // API Base URL
        const API_BASE_URL = '/api';

        // DOM Elements
        const browsePage = document.getElementById('browse-page');
        const whisperPage = document.getElementById('whisper-page');
        const whispersGrid = document.getElementById('whispers-grid');
        const fab = document.getElementById('fab');
        const postModal = document.getElementById('post-modal');
        const closeModal = document.getElementById('close-modal');
        const whisperTitleInput = document.getElementById('whisper-title');
        const titleChars = document.getElementById('title-chars');
        const newWhisperTextarea = document.getElementById('new-whisper');
        const whisperChars = document.getElementById('whisper-chars');
        const replyTextarea = document.getElementById('reply-textarea');
        const replyChars = document.getElementById('reply-chars');
        const replyWords = document.getElementById('reply-words');
        const replyCharCounter = document.getElementById('reply-char-counter');
        const submitReplyBtn = document.getElementById('submit-reply');
        const submitWhisperBtn = document.getElementById('submit-whisper');
        const fullWhisperTitle = document.getElementById('full-whisper-title');
        const fullWhisperContent = document.getElementById('full-whisper-content');
        const repliesContainer = document.getElementById('replies-container');
        const sensitiveIndicator = document.getElementById('sensitive-indicator');
        const deleteHours = document.getElementById('delete-hours');
        const backButton = document.getElementById('back-button');
        const homeButton = document.getElementById('home-button');
        const navBrowse = document.getElementById('nav-browse');
        const topicFilter = document.getElementById('topic-filter');
        const loadingIndicator = document.getElementById('loading');
        const moreBtn = document.getElementById('more-btn');
        const moreDropdown = document.getElementById('more-dropdown');
        const whisperContentCard = document.getElementById('whisper-content-card');
        const repliesSection = document.getElementById('replies-section');
        const exitWarningModal = document.getElementById('exit-warning-modal');
        const confirmExitBtn = document.getElementById('confirm-exit');
        const cancelExitBtn = document.getElementById('cancel-exit');
        const exitTimer = document.getElementById('exit-timer');
        const exitCountdown = document.getElementById('exit-countdown');

        // State
        let currentWhisper = null;
        let currentTopic = 'all';
        let lastUpdateTime = null;
        let autoReloadInterval = null;
        let revealedSensitiveCards = new Set();
        let exitTimeout = null;
        let exitCountdownInterval = null;
        let firstExitAttempt = false;
        let canExit = false;
        let lastBackPressTime = 0;

        // Initialize cosmic background
        function initCosmicBackground() {
            const bg = document.getElementById('cosmic-bg');
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.width = `${Math.random() * 3 + 1}px`;
                star.style.height = star.style.width;
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.opacity = Math.random() * 0.5 + 0.2;
                star.style.animationDelay = `${Math.random() * 5}s`;
                star.style.animationDuration = `${Math.random() * 4 + 2}s`;
                bg.appendChild(star);
            }
        }

        // Count words in text
        function countWords(text) {
            return text.trim().split(/\s+/).filter(word => word.length > 0).length;
        }

        // Format timestamp
        function formatTimeAgo(dateString) {
            try {
                let date;
                if (dateString.includes('Z')) {
                    date = new Date(dateString);
                } else if (dateString.includes('+')) {
                    date = new Date(dateString);
                } else {
                    date = new Date(dateString + 'Z');
                }
                
                const now = new Date();
                const diffMs = now - date;
                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffHours / 24);

                if (diffMinutes < 1) {
                    return 'Just now';
                } else if (diffMinutes < 60) {
                    return `${diffMinutes}m ago`;
                } else if (diffHours < 24) {
                    return `${diffHours}h ago`;
                } else if (diffDays < 7) {
                    return `${diffDays}d ago`;
                } else {
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            } catch (error) {
                console.error('Error formatting time:', error, dateString);
                return 'Recently';
            }
        }

        // Calculate remaining hours
        function getRemainingHours(createdAt) {
            try {
                const date = new Date(createdAt.includes('Z') ? createdAt : createdAt + 'Z');
                const now = new Date();
                const diffMs = now - date;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const remaining = 48 - diffHours;
                return Math.max(0, remaining);
            } catch (error) {
                return 48;
            }
        }

        // Format topic name for display
        function formatTopicName(topic) {
            return topic.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join('/').toUpperCase();
        }

        // Reset whisper page state
        function resetWhisperPage() {
            // Remove any existing warning
            const existingWarning = document.querySelector('.sensitive-warning');
            if (existingWarning) existingWarning.remove();
            
            // Ensure content and replies are visible
            whisperContentCard.classList.remove('hidden');
            repliesSection.classList.remove('hidden');
            
            // Reset reply textarea
            replyTextarea.value = '';
            replyChars.textContent = '0';
            replyWords.textContent = '0';
            document.getElementById('human-check').checked = false;
            replyCharCounter.classList.remove('warning');
            submitReplyBtn.disabled = false;
            submitReplyBtn.title = '';
        }

        // Smooth transition between pages
        function smoothTransition(toPage) {
            const fromPage = whisperPage.classList.contains('hidden') ? browsePage : whisperPage;
            
            // Add fade-out animation
            fromPage.style.opacity = '0';
            fromPage.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                fromPage.classList.add('hidden');
                toPage.classList.remove('hidden');
                toPage.style.opacity = '0';
                toPage.style.transform = 'translateY(20px)';
                
                // Force reflow
                toPage.offsetHeight;
                
                // Add fade-in animation
                setTimeout(() => {
                    toPage.style.opacity = '1';
                    toPage.style.transform = 'translateY(0)';
                    toPage.style.transition = 'opacity 0.4s ease-out, transform 0.4s ease-out';
                }, 10);
            }, 200);
            
            // Reset transition after animation
            setTimeout(() => {
                toPage.style.transition = '';
            }, 600);
        }

        // Handle browser back button
        function handleBrowserBack() {
            // If we're on whisper page, go back to browse page
            if (!whisperPage.classList.contains('hidden')) {
                // Use pushState to update URL without adding to history
                history.pushState({ page: 'browse' }, '', '/');
                smoothTransition(browsePage);
                startAutoReload();
                return false; // Prevent default back behavior
            }
            
            // If we're on browse page, show exit warning
            if (!browsePage.classList.contains('hidden')) {
                if (!firstExitAttempt) {
                    // First exit attempt - show warning
                    firstExitAttempt = true;
                    showExitWarning();
                    
                    // Reset after 5 seconds if no second attempt
                    setTimeout(() => {
                        if (firstExitAttempt) {
                            firstExitAttempt = false;
                            canExit = false;
                        }
                    }, 5000);
                    
                    return false; // Prevent default back behavior
                } else {
                    // Second exit attempt within time window
                    if (canExit) {
                        // Allow exit
                        return true;
                    } else {
                        // Show warning again
                        showExitWarning();
                        return false;
                    }
                }
            }
            
            return true;
        }

        // Show exit warning modal
        function showExitWarning() {
            exitWarningModal.style.display = 'flex';
            let countdown = 3;
            
            // Update timer display
            exitTimer.textContent = countdown;
            exitCountdown.textContent = countdown;
            
            // Start countdown
            exitCountdownInterval = setInterval(() => {
                countdown--;
                exitTimer.textContent = countdown;
                exitCountdown.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(exitCountdownInterval);
                    hideExitWarning();
                    firstExitAttempt = false;
                    canExit = false;
                }
            }, 1000);
            
            // Set timeout to auto-hide
            exitTimeout = setTimeout(() => {
                hideExitWarning();
                firstExitAttempt = false;
                canExit = false;
            }, 3000);
        }

        // Hide exit warning modal
        function hideExitWarning() {
            exitWarningModal.style.display = 'none';
            if (exitTimeout) {
                clearTimeout(exitTimeout);
                exitTimeout = null;
            }
            if (exitCountdownInterval) {
                clearInterval(exitCountdownInterval);
                exitCountdownInterval = null;
            }
        }

        // Handle exit confirmation
        function handleExit() {
            canExit = true;
            hideExitWarning();
            
            // Short delay to allow state update
            setTimeout(() => {
                // Trigger actual exit
                window.location.href = 'about:blank';
                // Or close window if in app context
                // window.close();
            }, 100);
        }

        // Check for updates from backend
        async function checkForUpdates() {
            try {
                const response = await fetch(`${API_BASE_URL}/check-updates?last_update=${encodeURIComponent(lastUpdateTime || '')}&topic=${encodeURIComponent(currentTopic)}`);
                const data = await response.json();

                if (data.success && data.has_updates) {
                    fetchWhispers(currentTopic);
                    lastUpdateTime = data.last_update;
                }
            } catch (error) {
                console.error('Error checking updates:', error);
            }
        }

        // Start auto-reload
        function startAutoReload() {
            if (autoReloadInterval) clearInterval(autoReloadInterval);
            
            autoReloadInterval = setInterval(() => {
                if (!postModal.style.display || postModal.style.display === 'none') {
                    checkForUpdates();
                }
            }, 2000);
        }

        // Stop auto-reload
        function stopAutoReload() {
            if (autoReloadInterval) {
                clearInterval(autoReloadInterval);
                autoReloadInterval = null;
            }
        }

        // Fetch whispers from backend
        async function fetchWhispers(topic = 'all') {
            try {
                loadingIndicator.style.display = 'block';
                const response = await fetch(`${API_BASE_URL}/whispers?topic=${topic}`);
                const data = await response.json();

                if (data.success) {
                    lastUpdateTime = data.last_update;
                    currentTopic = topic;
                    renderWhispers(data.data);
                    updateActiveTopicButton(topic);
                } else {
                    console.error('Failed to fetch whispers:', data.error);
                    whispersGrid.innerHTML = '<p style="color: var(--text-muted); text-align: center; grid-column: 1/-1; padding: 2rem;">Failed to load whispers</p>';
                }
            } catch (error) {
                console.error('Error fetching whispers:', error);
                whispersGrid.innerHTML = '<p style="color: var(--text-muted); text-align: center; grid-column: 1/-1; padding: 2rem;">Error loading whispers</p>';
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // Update active topic button in UI
        function updateActiveTopicButton(topic) {
            document.querySelectorAll('.topic-filter-btn, .dropdown-topic-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`[data-topic="${topic}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            if (!activeBtn && topic === 'all') {
                document.querySelector('.topic-filter-btn[data-topic="all"]').classList.add('active');
            }
        }

        // Fetch a single whisper
        async function fetchWhisper(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/whispers/${id}`);
                const data = await response.json();

                if (data.success) {
                    return data.data;
                } else {
                    console.error('Failed to fetch whisper:', data.error);
                    return null;
                }
            } catch (error) {
                console.error('Error fetching whisper:', error);
                return null;
            }
        }

        // Render whisper cards
        function renderWhispers(whispers) {
            if (whispers.length === 0) {
                whispersGrid.innerHTML = '<p style="color: var(--text-muted); text-align: center; grid-column: 1/-1; padding: 2rem;">No whispers found for this topic</p>';
                return;
            }

            whispersGrid.innerHTML = '';

            whispers.forEach(whisper => {
                const card = document.createElement('div');
                card.className = 'whisper-card';
                card.dataset.id = whisper.id;

                // Get title or use default
                const title = whisper.title || 'Untitled Whisper';
                const preview = whisper.content.length > 120
                    ? whisper.content.substring(0, 120) + '...'
                    : whisper.content;

                const remainingHours = getRemainingHours(whisper.created_at);
                const timeAgo = formatTimeAgo(whisper.created_at);
                const isRevealed = revealedSensitiveCards.has(whisper.id);

                card.innerHTML = `
                    ${whisper.is_sensitive && !isRevealed ? `
                        <div class="sensitive-overlay" data-whisper-id="${whisper.id}">
                            <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">‚ö†Ô∏è SENSITIVE CONTENT</div>
                            <p style="font-size: 0.9rem; margin-bottom: 1rem;">This whisper contains content that may be distressing.</p>
                            <button class="btn btn-secondary reveal-sensitive-btn" data-whisper-id="${whisper.id}">
                                REVEAL CONTENT
                            </button>
                        </div>
                    ` : ''}

                    <div class="card-header">
                        <div class="anonymous-icon">?</div>
                        <div class="topic-badge topic-${whisper.topic}">${formatTopicName(whisper.topic)}</div>
                    </div>
                    <div class="whisper-title ${whisper.is_sensitive && !isRevealed ? 'sensitive-blur' : ''}">
                        ${title}
                    </div>
                    <div class="whisper-preview ${whisper.is_sensitive && !isRevealed ? 'sensitive-blur' : ''}">
                        ${preview}
                    </div>
                    <div class="card-footer">
                        <div class="footer-left">
                            <div class="timestamp">üïí ${timeAgo}</div>
                        </div>
                        <div class="footer-right">
                            ${whisper.is_sensitive ? '<div class="sensitive-badge">‚ö†Ô∏è SENSITIVE</div>' : ''}
                            <div class="auto-delete">
                                ${remainingHours}h left
                            </div>
                        </div>
                    </div>
                `;

                // Add click handler for the card
                card.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('reveal-sensitive-btn')) {
                        openWhisper(whisper.id);
                    }
                });

                // Add event listener for reveal button if present
                const revealBtn = card.querySelector('.reveal-sensitive-btn');
                if (revealBtn) {
                    revealBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        revealSensitiveContent(whisper.id);
                    });
                }

                whispersGrid.appendChild(card);
            });
        }

        // Setup More Dropdown
        function setupMoreDropdown() {
            moreBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                moreDropdown.classList.toggle('show');
                moreBtn.classList.toggle('show');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', () => {
                moreDropdown.classList.remove('show');
                moreBtn.classList.remove('show');
            });

            // Handle dropdown topic clicks
            moreDropdown.addEventListener('click', (e) => {
                if (e.target.classList.contains('dropdown-topic-btn')) {
                    e.stopPropagation();
                    const topic = e.target.dataset.topic;
                    currentTopic = topic;
                    fetchWhispers(currentTopic);
                    moreDropdown.classList.remove('show');
                    moreBtn.classList.remove('show');
                }
            });
        }

        // Reveal sensitive content in card view
        function revealSensitiveContent(id) {
            revealedSensitiveCards.add(id);
            
            const card = document.querySelector(`.whisper-card[data-id="${id}"]`);
            if (card) {
                const overlay = card.querySelector('.sensitive-overlay');
                const title = card.querySelector('.whisper-title');
                const preview = card.querySelector('.whisper-preview');

                if (overlay) {
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        if (overlay.parentNode === card) {
                            overlay.remove();
                        }
                    }, 300);
                }
                if (title) {
                    title.classList.remove('sensitive-blur');
                }
                if (preview) {
                    preview.classList.remove('sensitive-blur');
                }
            }
        }

        // Open full whisper view
        async function openWhisper(id) {
            // Reset page state first
            resetWhisperPage();
            
            const whisper = await fetchWhisper(id);
            if (!whisper) return;

            currentWhisper = whisper;

            // Update topic badge
            const topicBadge = document.querySelector('.full-whisper-card .topic-badge');
            topicBadge.className = `topic-badge topic-${whisper.topic}`;
            topicBadge.textContent = formatTopicName(whisper.topic);

            // Update full view header topic
            document.getElementById('full-topic-badge').textContent = formatTopicName(whisper.topic);

            // Update title and content
            fullWhisperTitle.textContent = whisper.title || 'Untitled Whisper';
            fullWhisperContent.textContent = whisper.content;

            // Update timestamp
            document.getElementById('full-timestamp').textContent = formatTimeAgo(whisper.created_at);

            // Update replies count
            document.getElementById('full-replies-count').textContent = whisper.replies_count || 0;

            // Update sensitive indicator
            sensitiveIndicator.classList.toggle('hidden', !whisper.is_sensitive);

            // Update remaining hours
            const remainingHours = getRemainingHours(whisper.created_at);
            document.getElementById('delete-hours').textContent = remainingHours;

            // Fetch replies
            await fetchReplies(id);

            // Show sensitive warning if needed
            if (whisper.is_sensitive) {
                showSensitiveWarning();
            }

            // Switch pages with smooth transition
            smoothTransition(whisperPage);
            stopAutoReload();
            
            // Update history state
            history.pushState({ page: 'whisper', id: id }, '', `#whisper-${id}`);
        }

        // Show sensitive content warning (inside whisper view)
        function showSensitiveWarning() {
            // Hide content and replies while showing warning
            whisperContentCard.classList.add('hidden');
            repliesSection.classList.add('hidden');

            const warningHTML = `
                <div class="sensitive-warning" id="sensitive-warning">
                    <div class="warning-icon">‚ö†Ô∏è</div>
                    <h2>CONTENT WARNING</h2>
                    <p>This whisper contains sensitive content that some may find distressing.</p>
                    <div class="warning-buttons">
                        <button class="btn btn-danger" id="view-sensitive">CONTINUE READING</button>
                        <button class="btn btn-secondary" id="go-back">GO BACK</button>
                    </div>
                </div>
            `;

            const container = document.getElementById('whisper-container');
            const existingWarning = container.querySelector('.sensitive-warning');
            if (existingWarning) existingWarning.remove();

            container.insertAdjacentHTML('afterbegin', warningHTML);

            // Add fresh event listeners
            document.getElementById('view-sensitive').addEventListener('click', () => {
                revealContentAndReplies();
            });

            document.getElementById('go-back').addEventListener('click', () => {
                smoothTransition(browsePage);
                startAutoReload();
            });
        }

        // Reveal content and replies (after warning accepted)
        function revealContentAndReplies() {
            const warning = document.getElementById('sensitive-warning');
            if (warning) warning.remove();
            
            // Show content and replies with animation
            whisperContentCard.classList.remove('hidden');
            repliesSection.classList.remove('hidden');
            
            // Add animation
            whisperContentCard.style.animation = 'none';
            repliesSection.style.animation = 'none';
            setTimeout(() => {
                whisperContentCard.style.animation = 'slideIn 0.4s ease-out';
                repliesSection.style.animation = 'slideIn 0.5s ease-out';
            }, 10);
        }

        // Fetch replies
        async function fetchReplies(whisperId) {
            try {
                const response = await fetch(`${API_BASE_URL}/whispers/${whisperId}/replies`);
                const data = await response.json();

                if (data.success) {
                    renderReplies(data.data);
                } else {
                    console.error('Failed to fetch replies:', data.error);
                    renderReplies([]);
                }
            } catch (error) {
                console.error('Error fetching replies:', error);
                renderReplies([]);
            }
        }

        // Render replies
        function renderReplies(replies) {
            repliesContainer.innerHTML = '';

            if (replies.length === 0) {
                repliesContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No replies yet. Be the first to respond.</p>';
                return;
            }

            replies.forEach(reply => {
                const replyElement = document.createElement('div');
                replyElement.className = 'reply';
                replyElement.innerHTML = `
                    <div class="reply-content">${reply.content}</div>
                    <div class="reply-footer">
                        <div class="anonymous-indicator">Anonymous</div>
                        <div class="timestamp">${formatTimeAgo(reply.created_at)}</div>
                    </div>
                `;
                repliesContainer.appendChild(replyElement);
            });
        }

        // Post a new whisper
        async function postWhisper(title, content, topic, isSensitive) {
            try {
                const response = await fetch(`${API_BASE_URL}/whispers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title.trim(),
                        content,
                        topic,
                        is_sensitive: isSensitive
                    })
                });

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error posting whisper:', error);
                return { success: false, error: 'Failed to post whisper' };
            }
        }

        // Post a reply
        async function postReply(whisperId, content) {
            try {
                const response = await fetch(`${API_BASE_URL}/whispers/${whisperId}/replies`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content })
                });

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error posting reply:', error);
                return { success: false, error: 'Failed to post reply' };
            }
        }

        // Character counters
        whisperTitleInput.addEventListener('input', (e) => {
            titleChars.textContent = e.target.value.length;
        });

        newWhisperTextarea.addEventListener('input', (e) => {
            whisperChars.textContent = e.target.value.length;
        });

        // Reply textarea with word limit
        replyTextarea.addEventListener('input', (e) => {
            const text = e.target.value;
            const wordCount = countWords(text);
            const charCount = text.length;
            
            replyChars.textContent = charCount;
            replyWords.textContent = wordCount;
            
            // Check word limit
            if (wordCount > 150) {
                replyCharCounter.classList.add('warning');
                submitReplyBtn.disabled = true;
                submitReplyBtn.title = 'Maximum 150 words allowed';
            } else {
                replyCharCounter.classList.remove('warning');
                submitReplyBtn.disabled = false;
                submitReplyBtn.title = '';
            }
        });

        // Submit reply
        submitReplyBtn.addEventListener('click', async () => {
            const content = replyTextarea.value.trim();
            const humanCheck = document.getElementById('human-check').checked;
            const wordCount = countWords(content);

            if (!content) {
                alert('Please write a reply.');
                return;
            }

            if (!humanCheck) {
                alert('Please confirm you are human.');
                return;
            }

            if (wordCount > 150) {
                alert('Reply is too long. Maximum 150 words allowed.');
                return;
            }

            if (currentWhisper) {
                const result = await postReply(currentWhisper.id, content);

                if (result.success) {
                    // Refresh replies
                    await fetchReplies(currentWhisper.id);

                    // Reset form
                    replyTextarea.value = '';
                    replyChars.textContent = '0';
                    replyWords.textContent = '0';
                    document.getElementById('human-check').checked = false;

                    // Add visual feedback
                    submitReplyBtn.textContent = 'REPLIED!';
                    submitReplyBtn.style.background = 'linear-gradient(45deg, #64ff64, #00c800)';
                    setTimeout(() => {
                        submitReplyBtn.textContent = 'POST REPLY';
                        submitReplyBtn.style.background = '';
                    }, 2000);
                } else {
                    alert('Failed to post reply: ' + result.error);
                }
            }
        });

        // Post new whisper
        submitWhisperBtn.addEventListener('click', async () => {
            const title = whisperTitleInput.value.trim();
            const content = newWhisperTextarea.value.trim();
            const topic = document.getElementById('whisper-topic').value;
            const sensitive = document.getElementById('sensitive-toggle-modal').checked;
            const humanCheck = document.getElementById('post-human-check').checked;

            if (!title) {
                alert('Please give your whisper a title.');
                return;
            }

            if (!content) {
                alert('Please write a whisper.');
                return;
            }

            if (!humanCheck) {
                alert('Please confirm you are human.');
                return;
            }

            if (title.length > 100) {
                alert('Title is too long. Maximum 100 characters.');
                return;
            }

            if (content.length > 1000) {
                alert('Whisper is too long.');
                return;
            }

            const result = await postWhisper(title, content, topic, sensitive);

            if (result.success) {
                // Reset form and close modal
                whisperTitleInput.value = '';
                titleChars.textContent = '0';
                newWhisperTextarea.value = '';
                whisperChars.textContent = '0';
                document.getElementById('whisper-topic').value = 'confession';
                document.getElementById('sensitive-toggle-modal').checked = false;
                document.getElementById('post-human-check').checked = false;
                postModal.style.display = 'none';

                // Add visual feedback
                const originalText = submitWhisperBtn.textContent;
                submitWhisperBtn.textContent = 'WHISPERED!';
                submitWhisperBtn.style.background = 'linear-gradient(45deg, #64ff64, #00c800)';
                setTimeout(() => {
                    submitWhisperBtn.textContent = originalText;
                    submitWhisperBtn.style.background = '';
                }, 2000);
                
                // Refresh whispers to show the new post
                fetchWhispers(currentTopic);
            } else {
                alert('Failed to post whisper: ' + result.error);
            }
        });

        // Topic filter
        topicFilter.addEventListener('click', (e) => {
            if (e.target.classList.contains('topic-filter-btn') && !e.target.classList.contains('more-button')) {
                const topic = e.target.dataset.topic;
                currentTopic = topic;
                fetchWhispers(currentTopic);
                moreDropdown.classList.remove('show');
                moreBtn.classList.remove('show');
            }
        });

        // Back button
        backButton.addEventListener('click', () => {
            smoothTransition(browsePage);
            startAutoReload();
            history.replaceState({ page: 'browse' }, '', '/');
        });

        // Browse whispers button (refresh)
        navBrowse.addEventListener('click', (e) => {
            e.preventDefault();
            if (!whisperPage.classList.contains('hidden')) {
                smoothTransition(browsePage);
                startAutoReload();
                history.replaceState({ page: 'browse' }, '', '/');
            } else {
                // Already on browse page, refresh whispers
                fetchWhispers(currentTopic);
            }
        });

        // Home button (logo)
        homeButton.addEventListener('click', () => {
            if (!browsePage.classList.contains('hidden')) return;
            
            smoothTransition(browsePage);
            startAutoReload();
            history.replaceState({ page: 'browse' }, '', '/');
        });

        // Handle browser back/forward buttons
        window.addEventListener('popstate', (event) => {
            // If we're on whisper page and user presses back, go to browse
            if (!whisperPage.classList.contains('hidden')) {
                smoothTransition(browsePage);
                startAutoReload();
            }
            // If we're on browse page and there's state, stay on browse
            // (handled by the back button prevention logic)
        });

        // Prevent accidental back navigation when on whisper page
        window.addEventListener('beforeunload', (e) => {
            // Only show warning if we're on browse page and have exit confirmation enabled
            if (!browsePage.classList.contains('hidden') && firstExitAttempt && !canExit) {
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave? Press exit button twice to confirm.';
                return e.returnValue;
            }
        });

        // Initialize history state
        history.replaceState({ page: 'browse' }, '', '/');

        // FAB and modal handling
        fab.addEventListener('click', () => {
            postModal.style.display = 'flex';
        });

        closeModal.addEventListener('click', () => {
            postModal.style.display = 'none';
        });

        postModal.addEventListener('click', (e) => {
            if (e.target === postModal) {
                postModal.style.display = 'none';
            }
        });

        // Exit warning handlers
        confirmExitBtn.addEventListener('click', handleExit);
        cancelExitBtn.addEventListener('click', () => {
            hideExitWarning();
            firstExitAttempt = false;
            canExit = false;
        });

        // Double-tap back button detection for mobile
        let lastTapTime = 0;
        document.addEventListener('touchend', (e) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTapTime;
            
            if (tapLength < 500 && tapLength > 0) {
                // Double tap detected
                e.preventDefault();
                
                if (!whisperPage.classList.contains('hidden')) {
                    // If on whisper page, go back to browse
                    smoothTransition(browsePage);
                    startAutoReload();
                    history.replaceState({ page: 'browse' }, '', '/');
                } else {
                    // If on browse page, show exit warning
                    if (!firstExitAttempt) {
                        firstExitAttempt = true;
                        showExitWarning();
                        
                        setTimeout(() => {
                            if (firstExitAttempt) {
                                firstExitAttempt = false;
                                canExit = false;
                            }
                        }, 5000);
                    } else if (canExit) {
                        handleExit();
                    } else {
                        showExitWarning();
                    }
                }
            }
            
            lastTapTime = currentTime;
        });

        // Initialize
        initCosmicBackground();
        setupMoreDropdown();
        fetchWhispers('all');
        startAutoReload();
    </script>
</body>
</html>